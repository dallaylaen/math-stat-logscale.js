<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Univariate statistical analysis</title>
    <script src="js/logscale-stat.js"></script>
</head>
<body>
<canvas id="draw" style="border: solid red 1px"></canvas>
<pre id="output"></pre>

<div id="add-numbers">
<p style="color:grey">Enter code here. Use <tt>stat.add( number, ... )</tt>
to add numbers to the dataset
and <tt>data</tt> to refer to uploaded file content (if any).</p>
<textarea id="code" style="width: 80%; height: 10em">
for( let i = 0; i<10000; i++) {
    stat.add(-Math.log(Math.random()));
};
</textarea><br>
<input type="file" id="file">
<button onclick="return run()">Run code</button>
<button onclick="return reset()">Reset stat</button>
</div>

<script>
    const out      = document.getElementById('output');
    const userCode = document.getElementById('code');
    const canvas   = document.getElementById('draw');
    const inFile   = document.getElementById('file');
    let stat;

    reset();

    function run() {
        const code = userCode.value;

        // TODO isolate via web workers if available
        // TODO fancy error msg

        const promise = inFile.files[0] ? inFile.files[0].text() : Promise.resolve('');

        promise.then( resolve => {
            let data = '' + resolve;
            eval(code);
            show();
            draw();
        });
    }


    function reset() {
        stat = new logstat.Univariate();
        // TODO also specify precision
        show();
        draw();
    }

    function show() {
        out.innerHTML = '';
        out.innerHTML += 'count: '+stat.count()+'\n';
        out.innerHTML += 'min: '+stat.min()+'\n';
        out.innerHTML += 'max: '+stat.max()+'\n';
        out.innerHTML += 'mean: '+stat.mean()+'\n';
        out.innerHTML += 'stdev: '+stat.stdev()+'\n';
        out.innerHTML += 'median: '+stat.quantile(0.5)+'\n';
    }

    function draw() {
        const height = Math.floor(Number.parseInt(screen.height) / 5);
        const width  = Math.floor(Number.parseInt(screen.width) * 0.8) - 10;

        canvas.height = height + 16;
        canvas.width = width + 48;

        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.stroke();

        if(!stat.count())
            return;

        ctx.lineWidth = 1;
        ctx.strokeStyle = 'orange';

        const hist = stat.histogram({count:width, scale:height});

        for (let i = 0; i<width; i++) {
            ctx.beginPath();
            ctx.moveTo( i + 8, height );
            ctx.lineTo( i + 8, height - Math.ceil(hist[i][0]) );
            ctx.stroke();
        }

        for (let i = 0; i<11; i++) {
            ctx.beginPath();
            ctx.strokeStyle = 'black';
            ctx.font = "8px Sans";
            const label = stat.shorten(stat.min() + (stat.max() - stat.min())*i/10);
            ctx.setLineDash([1,3]);
            ctx.moveTo( width*i/10 + 8, canvas.height-12 );
            ctx.lineTo( width*i/10 + 8, 0 );
            ctx.stroke();
            ctx.setLineDash([1,0]);
            ctx.strokeText( label, width*i/10 + 8, canvas.height-1 );
        }
    }
    
</script>
</body>
</html>
